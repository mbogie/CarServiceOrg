<apex:page standardController="Mechanic__c" extensions="CsMechanicDetailController" tabStyle="Mechanic__c">

    <apex:includeScript value="{!$Resource.jQuery}"/>
    <apex:includeScript value="{!$Resource.DefaultPicture}"/>
    <apex:includeScript value="{!URLFOR($Resource.jQueryUI,'jquery-ui-1.12.1.custom/jquery-ui.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.jQueryUI,'jquery-ui-1.12.1.custom/jquery-ui.css')}"/>

    <style>
        #pictureDiv {
            width: 10%;
            float: left;
            height: 120px;
        }

        #detailsDiv {
            width: 90%;
            float: right;
            height: 130px;
        }
    </style>

    <apex:form id="mechanicForm">
        <apex:message />
        <apex:pageBlock id="mechanicBlock" title="{!Mechanic__c.Full_Name__c}">
            <div id="detailSectionDiv">
                <div id="pictureDiv">
                    <apex:image alt="Profile Picture" title="Picture"
                                url="{!URLFOR($Resource.DefaultPicture, 'default.png')}" style="height: 120px"/>
                </div>
                <div id="detailsDiv">
                    <apex:pageBlockSection id="detailSection" title="{!$Label.Section_Details}">
                        <apex:outputField value="{!Mechanic__c.First_Name__c}"/>
                        <apex:outputField value="{!Mechanic__c.Speciality__c}"/>
                        <apex:outputField value="{!Mechanic__c.Name}"/>
                        <apex:outputField value="{!Mechanic__c.Skill__c}"/>
                        <apex:outputField value="{!Mechanic__c.License_Number__c}"/>
                        <apex:outputField value="{!Mechanic__c.Email__c}"/>
                        <apex:outputField id="copyPhone" value="{!Mechanic__c.Phone__c}">
                            <apex:commandButton value="{!$Label.Copy_To_Clipboard}"
                                                onClick="clipBoard('{!$Component.copyPhone}')" reRender="copytext"/>
                        </apex:outputField>
                        <apex:outputField value="{!Mechanic__c.Birthday__c}"/>
                    </apex:pageBlockSection>
                </div>
            </div>
            <div style="clear: both">
                <apex:pageBlockSection id="addressSection" title="{!$Label.Section_Address}">
                    <apex:outputField value="{!Mechanic__c.Address__c}"/>
                    <apex:outputField value="{!Mechanic__c.City__c}"/>
                    <apex:outputField value="{!Mechanic__c.Country__c}"/>
                    <apex:outputField value="{!Mechanic__c.Zip_Code__c}"/>
                </apex:pageBlockSection>
            </div>
            <div id="buttonSection" align="center" draggable="false">
                <apex:commandButton value="{!$Label.Button_Edit}" action="{!edit}"/>
                <apex:commandButton value="{!$Label.Button_Hire}" onClick="openHirePopup()" onComplete="refresh"/>
                <apex:commandButton value="{!$Label.Button_Save_To_Pdf}" action="{!saveToPdf}"/>
                <apex:commandButton value="{!$Label.Button_Delete}"
                                    onclick="if(!confirm('{!$Label.Delete_Confirm_Message}')) return false;"
                                    action="{!deleteMechanic}"/>
            </div>
        </apex:pageBlock>
        <apex:outputPanel id="relatedLists">
            <apex:pageBlock id="historyBlock" title="{!$Label.Section_History_Tracking}">
                <apex:pageBlockTable id="historyTable" value="{!Mechanic__c.Histories}" var="history">
                    <apex:column value="{!history.CreatedDate}"/>
                    <apex:column value="{!history.CreatedById}"/>
                    <apex:column value="{!history.Field}"/>
                    <apex:column value="{!history.OldValue}"/>
                    <apex:column value="{!history.NewValue}"/>
                </apex:pageBlockTable>
            </apex:pageBlock>
            <apex:pageBlock id="AgreementsBlock" title="{!$Label.Section_Agreements}">
                <apex:pageBlockTable id="agreementsTable" value="{!Mechanic__c.Contracts__r}" var="contract">
                    <apex:column headerValue="{!$Label.Action_Table_Label}">
                        <apex:commandLink action="{!dismiss}"
                                          reRender="mechanicForm,messages,relatedLists">{!IF(ISNULL(contract.End_Date__c), $Label.Action_Dissmiss, IF(contract.End_Date__c > TODAY(),$Label.Action_Dissmiss,''))}
                            <apex:param name="selectedContract" value="{!contract.Id}"
                                        assignTo="{!contractToInsert.Id}"></apex:param>
                        </apex:commandLink>
                    </apex:column>
                    <apex:column value="{!contract.Name}"/>
                    <apex:column value="{!contract.Workshop__c}"/>
                    <apex:column value="{!contract.Start_Date__c}"/>
                    <apex:column value="{!contract.End_Date__c}"/>
                </apex:pageBlockTable>
            </apex:pageBlock>
        </apex:outputPanel>
    </apex:form>

    <div id="agreement" title="{!hirePopupLabel}">
        <div id="myMessagess">
            <apex:outputPanel id="messages">
                <apex:pageMessages id="messageTxt" showDetail="false"/>
                <script>
                    var messageID = '{!$Component.messageTxt}';
                </script>
            </apex:outputPanel>
        </div>
        <apex:outputPanel id="form">
            <apex:form id="workshopForm">
                <apex:actionRegion id="searchRegion">
                    <apex:outputPanel id="fieldPanel">
                        <apex:pageBlock id="workshopInfo">
                            <apex:pageBlockSection id="workshopsSearchFields">
                                <apex:inputField value="{!workshopPageFormController.Name}" required="true"/>
                                <apex:inputField value="{!workshopPageFormController.Country__c}"/>
                                <apex:inputField value="{!workshopPageFormController.City__c}"/>
                            </apex:pageBlockSection>
                            <div id="workshopsSearchButtons" align="center" draggable="false">
                                <apex:actionFunction name="clear" action="{!cancel}" immediate="true"
                                                     reRender="form,messages"/>
                                <apex:commandButton value="{!$Label.Button_Search}" action="{!search}"
                                                    reRender="form,messages"/>
                                <apex:commandButton value="{!$Label.Button_Clear}" onclick="this.form.reset();"
                                                    action="{!clear}" immediate="true"
                                                    reRender="form,messages"/>
                            </div>
                        </apex:pageBlock>
                    </apex:outputPanel>
                </apex:actionRegion>
                <apex:outputPanel id="listPanel" rendered="{!isWorkshopSectionReady}">
                    <apex:pageBlock id="workshopList">
                        <apex:pageBlockTable id="workshopsTableBlock" value="{!workshopsSearchResultList}"
                                             var="workshop">
                            <apex:column headerValue="{!$Label.Action_Table_Label}">
                                <apex:commandLink action="{!choose}" immediate="true"
                                                  reRender="form,messages">{!IF(workshop.Id==workshopChoosen.Id, '', $Label.Select )}
                                    <apex:param name="selectedWorkshop" value="{!workshop.Id}"
                                                assignTo="{!workshopChoosen.Id}"></apex:param>
                                </apex:commandLink>
                            </apex:column>
                            <apex:column value="{!workshop.Name}">
                                <apex:facet name="header">
                                    <apex:commandLink action="{!sortByName}" immediate="true"
                                                      reRender="workshopsTableBlock,contractPanel">{!$ObjectType.Workshop__c.fields.Name.Label}
                                    {!IF(sortField == 'Name', IF(sortDirection=="ASC", $Label.Sign_Down,  $Label.Sign_Up ), '')}
                                    </apex:commandLink>
                                </apex:facet>
                            </apex:column>
                            <apex:column value="{!workshop.City__c}">
                                <apex:facet name="header">
                                    <apex:commandLink action="{!sortByCity}" immediate="true"
                                                      reRender="workshopsTableBlock,contractPanel">{!$ObjectType.Workshop__c.fields.City__c.Label}
                                    {!IF(sortField == 'City__c', IF(sortDirection=="ASC", $Label.Sign_Down,  $Label.Sign_Up ), '')}
                                    </apex:commandLink>
                                </apex:facet>
                            </apex:column>
                            <apex:column value="{!workshop.Country__c}">
                                <apex:facet name="header">
                                    <apex:commandLink action="{!sortByCountry}" immediate="true"
                                                      reRender="workshopsTableBlock,contractPanel">{!$ObjectType.Workshop__c.fields.Country__c.Label}
                                    {!IF(sortField == 'Country__c', IF(sortDirection=="ASC", $Label.Sign_Down,  $Label.Sign_Up ), '')}
                                    </apex:commandLink>
                                </apex:facet>
                            </apex:column>
                        </apex:pageBlockTable>
                    </apex:pageBlock>
                </apex:outputPanel>
                <apex:actionRegion id="contractFormRegion">
                    <apex:outputPanel id="contractPanel" rendered="{!isContractSectionReady}">
                        <apex:pageBlock id="contractBlock" title="{!$Label.Agreement}"
                                        rendered="{!isContractSectionReady}">
                            <apex:pageBlockSection id="mechanicWorkshopNameSection">
                                <apex:outputField value="{!Mechanic__c.Full_Name__c}"/>
                                <apex:pageBlockSectionItem />
                                <apex:outputField value="{!workshopChoosen.Name}"/>
                                <apex:pageBlockSectionItem />
                                <apex:inputField value="{!contractPageFormController.Start_Date__c}" required="true"/>
                                <apex:inputField value="{!contractPageFormController.End_Date__c}"/>
                            </apex:pageBlockSection>
                            <div id="agreementsButtons" align="center" draggable="false">
                                <apex:commandButton value="{!$Label.Button_Hire}" action="{!hire}" onComplete="checkHideModal();"
                                                    reRender="form,messages,mechanicForm"/>
                                <apex:commandButton value="{!$Label.Button_Cancel}" action="{!cancel}"
                                                    reRender="form,messages" onComplete="closeHirePopup();"/>
                            </div>
                        </apex:pageBlock>
                    </apex:outputPanel>
                </apex:actionRegion>
            </apex:form>
        </apex:outputPanel>
    </div>

    <script type="text/javascript">
        $('#agreement').dialog({
            autoOpen: false,
            height: "auto",
            width: 600,
            position: {
                my: 'top',
                at: 'top'
            },
            beforeClose: function () {
                clear();
            }

        });

        function openHirePopup() {
            $('#agreement').dialog("open");
        }

        function closeHirePopup() {
            $('#agreement').dialog("close");
        }

        function checkHideModal() {
            let errors = document.getElementById('messageID').textContent;
            if (!(errors.indexOf('Er') != -1)) {
                closeHirePopup();
            }
        }

        function clipBoard(copyPhone) {
            var aux = document.createElement("input");
            aux.setAttribute("value", document.getElementById(copyPhone).innerHTML);
            document.body.appendChild(aux);
            aux.select();
            document.execCommand("copy");
            document.body.removeChild(aux);
        }
    </script>

</apex:page>

