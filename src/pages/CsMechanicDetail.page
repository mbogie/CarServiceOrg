<apex:page standardController="Mechanic__c" extensions="CsMechanicDetailController" tabStyle="Mechanic__c">

    <apex:includeScript value="{!$Resource.jQuery}"/>
    <apex:includeScript value="{!URLFOR($Resource.jQueryUI,'jquery-ui-1.12.1.custom/jquery-ui.js')}"/>
    <apex:stylesheet value="{!URLFOR($Resource.jQueryUI,'jquery-ui-1.12.1.custom/jquery-ui.css')}"/>

    <apex:form id="mechanicForm">
        <apex:message/>
        <apex:pageBlock id="mechanicBlock" title="{!Mechanic__c.Full_Name__c}">
            <apex:pageBlockSection id="detailSection" title="{!$Label.Section_Details}">
                <apex:outputField value="{!Mechanic__c.First_Name__c}"/>
                <apex:outputField value="{!Mechanic__c.Speciality__c}"/>
                <apex:outputField value="{!Mechanic__c.Name}"/>
                <apex:outputField value="{!Mechanic__c.Skill__c}"/>
                <apex:outputField value="{!Mechanic__c.License_Number__c}"/>
                <apex:outputField value="{!Mechanic__c.Email__c}"/>
                <apex:outputField value="{!Mechanic__c.Phone__c}"/>
            </apex:pageBlockSection>
            <apex:pageBlockSection id="addressSection" title="{!$Label.Section_Address}">
                <apex:outputField value="{!Mechanic__c.Address__c}"/>
                <apex:outputField value="{!Mechanic__c.City__c}"/>
                <apex:outputField value="{!Mechanic__c.Country__c}"/>
                <apex:outputField value="{!Mechanic__c.Zip_Code__c}"/>
            </apex:pageBlockSection>
            <apex:pageBlockButtons id="buttonSection" location="bottom">
                <apex:commandButton value="{!$Label.Button_Edit}" action="{!edit}"/>
                <apex:commandButton value="{!$Label.Button_Hire}" onClick="openHirePage()" onComplete="refresh"/>
                <apex:commandButton value="{!$Label.Button_Delete}"
                                    onclick="if(!confirm('{!$Label.Delete_Confirm_Message}')) return false;"
                                    action="{!deleteM}"/>
            </apex:pageBlockButtons>
        </apex:pageBlock>
        <apex:pageBlock id="historyBlock" title="{!$Label.Section_History_Tracking}">
            <apex:pageBlockTable id="historyTable" value="{!Mechanic__c.Histories}" var="history">
                <apex:column value="{!history.CreatedDate}"/>
                <apex:column value="{!history.CreatedById}"/>
                <apex:column value="{!history.Field}"/>
                <apex:column value="{!history.OldValue}"/>
                <apex:column value="{!history.NewValue}"/>
            </apex:pageBlockTable>
        </apex:pageBlock>
        <apex:pageBlock id="AgreementsBlock" title="{!$Label.Section_Agreements}">
            <apex:pageBlockTable id="agreementsTable" value="{!Mechanic__c.Contracts__r}" var="contract">
                <apex:column value="{!contract.Name}"/>
                <apex:column value="{!contract.Workshop__c}"/>
                <apex:column value="{!contract.Start_Date__c}"/>
                <apex:column value="{!contract.End_Date__c}"/>
            </apex:pageBlockTable>
        </apex:pageBlock>
    </apex:form>

    <div id="agreement" title="Hire {!Mechanic__c.Full_Name__c} to...">
        <div id="myMessagess">
            <apex:outputPanel id="messages">
                <apex:pageMessages id="messageTxt" showDetail="false"/>
                <script>
                    var messageID = '{!$Component.messageTxt}';
                </script>
            </apex:outputPanel>
        </div>
        <apex:outputPanel id="form">
            <apex:form id="workshopForm">
                <apex:outputPanel id="fieldPanel">
                    <apex:pageBlock id="workshopInfo">
                        <apex:pageBlockSection id="workshopsSearchFields">
                            <apex:inputField value="{!workshopController.Name}" required="true"/>
                            <apex:inputField value="{!workshopController.Country__c}"/>
                            <apex:inputField value="{!workshopController.City__c}"/>
                        </apex:pageBlockSection>
                        <apex:pageBlockButtons id="workshopsSearchButtons" location="bottom">
                            <apex:commandButton value="{!$Label.Button_Search}" action="{!search}"
                                                reRender="form,messages"/>
                            <apex:commandButton value="{!$Label.Button_Clear}" action="{!clear}" immediate="true"
                                                reRender="form,messages"/>
                        </apex:pageBlockButtons>
                    </apex:pageBlock>
                </apex:outputPanel>
                <apex:outputPanel id="listPanel" rendered="{!workshopSectionReady}">
                    <apex:pageBlock id="workshopList">
                        <apex:pageBlockTable id="workshopsTableBlock" value="{!workshopsSearchResultList}"
                                             var="workshop">
                            <apex:column headerValue="{!$Label.Action_Table_Label}">
                                <apex:commandLink action="{!choose}" immediate="true"
                                                  reRender="form,contractForm">{!IF(workshop.Id==selectedWorkshopId, '', $Label.Select )}
                                    <apex:param name="selectedWorkshop" value="{!workshop.Id}"
                                                assignTo="{!selectedWorkshopId}"></apex:param>
                                </apex:commandLink>
                            </apex:column>
                            <apex:column value="{!workshop.Name}">
                                <apex:facet name="header">
                                    <apex:commandLink action="{!sortByName}" immediate="true"
                                                      reRender="workshopsTableBlock,contractPanel">{!$Label.Field_Name}
                                    {!IF(sortField == 'Name', IF(sortDirection=="ASC", $Label.Sign_Down,  $Label.Sign_Up ), '')}
                                    </apex:commandLink>
                                </apex:facet>
                            </apex:column>
                            <apex:column value="{!workshop.City__c}">
                                <apex:facet name="header">
                                    <apex:commandLink action="{!sortByCity}" immediate="true"
                                                      reRender="workshopsTableBlock,contractPanel">{!$Label.Field_City}
                                    {!IF(sortField == 'City__c', IF(sortDirection=="ASC", $Label.Sign_Down,  $Label.Sign_Up ), '')}
                                    </apex:commandLink>
                                </apex:facet>
                            </apex:column>
                            <apex:column value="{!workshop.Country__c}">
                                <apex:facet name="header">
                                    <apex:commandLink action="{!sortByCountry}" immediate="true"
                                                      reRender="workshopsTableBlock,contractPanel">{!$Label.Field_Country}
                                    {!IF(sortField == 'Country__c', IF(sortDirection=="ASC", $Label.Sign_Down,  $Label.Sign_Up ), '')}
                                    </apex:commandLink>
                                </apex:facet>
                            </apex:column>
                        </apex:pageBlockTable>
                    </apex:pageBlock>
                </apex:outputPanel>
            </apex:form>
            <apex:form id="contractForm">
                <apex:outputPanel id="contractPanel" rendered="{!contractSectionReady}">
                    <apex:pageBlock id="contractBlock" title="Agreement" rendered="{!contractSectionReady}">
                        <apex:pageBlockSection id="mechanicWorkshopNameSection">
                            <apex:outputField value="{!Mechanic__c.Full_Name__c}"/>
                            <apex:pageBlockSectionItem/>
                            <apex:outputField value="{!workshopChoosen.Name}"/>
                            <apex:pageBlockSectionItem/>
                            <apex:inputField value="{!contractController.Start_Date__c}" required="true"/>
                            <apex:inputField value="{!contractController.End_Date__c}"/>
                        </apex:pageBlockSection>
                        <apex:pageBlockButtons id="agreementsButtons" location="bottom">
                            <apex:commandButton value="{!$Label.Button_Hire}" action="{!hire}" reRender="form,messages"
                                                onComplete="checkHideModal();"/>
                            <apex:commandButton value="{!$Label.Button_Cancel}" action="{!cancel}"
                                                reRender="form,messages" onComplete="close();"/>
                        </apex:pageBlockButtons>
                    </apex:pageBlock>
                </apex:outputPanel>
            </apex:form>
        </apex:outputPanel>
    </div>

    <script type="text/javascript">
        $('#agreement').dialog({
            autoOpen: false,
            height: "auto",
            width: 600,
            position: {
                my: 'top',
                at: 'top'
            },
        });

        function openHirePage() {
            $('#agreement').dialog("open");
        }

        function close() {
            $('#agreement').dialog("close");
        }

        function checkHideModal() {
            let errors = document.getElementById('messageID').textContent;
            if (!(errors.indexOf('Er') != -1)) {
                close();
            }
        }
    </script>

</apex:page>